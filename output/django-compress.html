<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zhi An, Curious, creative, programmer. Open-source enthusiast">


        <title>Django compressor // Zhi An // Curious, creative, programmer. Open-source enthusiast</title>

    <link href="http://i.imgur.com/dA0h5oc.jpg" rel="icon">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="./theme/css/pure.css">
    <link rel="stylesheet" href="./theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <div class="cover-img" style="background-image: url('http://i.imgur.com/TAYo0g1.png')">
                <div class="cover-body">
                    <header class="header">
                        <hgroup>
                            <img class="avatar" src="http://i.imgur.com/dA0h5oc.jpg">
                            <h1 class="brand-main"><a href=".">Zhi An</a></h1>
                            <p class="tagline">Curious, creative, programmer. Open-source enthusiast</p>
                                <p class="social">
                                    <a href="http://github.com/ngzhian">
                                        <i class="fa fa-github fa-3x"></i>
                                    </a>
                                </p>
                        </hgroup>
                    </header>
                </div>
            </div>
        </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Django compressor</h1>
                        <p class="post-meta">
                            // under                                 <a class="post-category" href="./tag/python.html">python</a>
                                <a class="post-category" href="./tag/django.html">django</a>
                                <a class="post-category" href="./tag/web.html">web</a>
                        </p>
                </header>
            </section>
            <p>in an ideal world, websites would load instantaenously.
my latest task was to move my company's website close to this ideal.</p>
<p>we ran a django shop, and there is a wonderful package called django-compressor that helps us compress our static files easily.
it works as a template processor, finding the <code>{% compress %}</code> tags in your templates, and squeezes all the css or js files into a single file,
identified by a unique string.</p>
<h1>goal: a website that loads lightning quick</h1>
<p>our goal is simple: improve page load speed. there are two ways that django-compressor can help us with this:
1) reduce the number of http calls, <em>x</em> css/js file is now <em>1</em> file
2) reduce size of the file</p>
<p>2 is achieved by the various filters that django-compressor can call, which includes minifiers and uglifiers.</p>
<p>we also want this to be easy to scale, so that when we add new template, the additional css and/or js files that come with it will be
automatically compressed together with the previous ones.
this consideration led to the following tactic:</p>
<h1>single compress tag</h1>
<p>all vital scripts are in the base template, and template specific scripts go into the <code>{% block scripts %}</code> tag.</p>
<p>the compress {% compess js %} tag then wraps everything:</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">compress</span> <span class="nv">js</span> <span class="cp">%}</span>
<span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">&quot;/essential/scripts.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">scripts</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endcompress</span> <span class="cp">%}</span>
</pre></div>


<p>in this case, any child templates can just dump their js into the <code>scripts</code> block and they will be compressed.</p>
<h1>brick wall #1</h1>
<p>the first obstacle we faced was a runtime js error, which happened we we loaded our pages.
compression was fine, but the compressed js files were not behaving the same way as the uncompressed js, which was strange.
however it was easy to track down what the problem was (it was missing semicolons), and helped make our js a little more robust</p>
<h1>brick wall #2</h1>
<p>while testing on local environment, we would set offline comrepssion to false.
this meant that compression would occur for a single page only when it was loaded (traverse templates, find all files and compress into a single file).
our homepage worked fine, but as we started to click through to other pages, error started popping up about ill-formed js.
digging into those files led to a discovery -- when the compressor runs through the js code, it would check that the js is valid.
this meant that using template variables {{ x }} in js code would result in an error, because that isn't valid js.
this probably has to do with the order of template rendering which i'm not familiar with, but the way this was fixed was to move those particular js
out of the compress block.</p>
<p>how offelin compession work is that it traverses all the templates and generates all required js and css files, name them using an identifier and
for each page generate the js and css file so that the next time they are generated, the files will already be there</p>
<p>beware</p>
<p>offline key not found error: template variables in compress tags
compress invalid javascript syntax checking</p>
            <a href="#" class="go-top">Go Top</a>
<footer class="footer">
    <p>&copy; Ng Zhi An &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure-single">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
    </div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>

</body>
</html>